# .github/workflows/bundle-size.yml
name: Bundle Size Analysis

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  analyze-bundle:
    name: Analyze Bundle Size
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v3

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Bundle React Native (Android/iOS)
        run: |
          mkdir -p bundle/android bundle/ios
          # Android Metro bundle
          pnpx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output bundle/index.android.bundle \
            --assets-dest bundle/android || {
              echo "React Native CLI not found or failed."
              exit 1
            }

          # iOS Metro bundle
          pnpx react-native bundle \
            --platform ios \
            --dev false \
            --entry-file index.js \
            --bundle-output bundle/index.ios.bundle \
            --assets-dest bundle/ios || {
              echo "React Native CLI not found or failed."
              exit 1
            }

          # Compute PR bundle sizes
          ANDROID_BYTES=$(wc -c < bundle/index.android.bundle || echo 0)
          IOS_BYTES=$(wc -c < bundle/index.ios.bundle || echo 0)
          ANDROID_ASSETS_BYTES=$(du -sb bundle/android | cut -f1 || echo 0)
          IOS_ASSETS_BYTES=$(du -sb bundle/ios | cut -f1 || echo 0)

          echo "PR_ANDROID_BYTES=$ANDROID_BYTES" >> $GITHUB_ENV
          echo "PR_IOS_BYTES=$IOS_BYTES" >> $GITHUB_ENV
          echo "PR_ANDROID_ASSETS_BYTES=$ANDROID_ASSETS_BYTES" >> $GITHUB_ENV
          echo "PR_IOS_ASSETS_BYTES=$IOS_ASSETS_BYTES" >> $GITHUB_ENV

          echo "PR_ANDROID_SIZE=$(du -h bundle/index.android.bundle | cut -f1)" >> $GITHUB_ENV
          echo "PR_IOS_SIZE=$(du -h bundle/index.ios.bundle | cut -f1)" >> $GITHUB_ENV
          echo "PR_ANDROID_ASSETS_SIZE=$(du -sh bundle/android | cut -f1)" >> $GITHUB_ENV
          echo "PR_IOS_ASSETS_SIZE=$(du -sh bundle/ios | cut -f1)" >> $GITHUB_ENV

          # Build APK size if android project exists (optional)
          if [ -d android ]; then
            echo "Android project detected. Attempting assembleDebug for APK size..."
            sudo apt-get update -y && sudo apt-get install -y openjdk-17-jdk || true
            echo "sdk.dir=$HOME/Android/Sdk" >> android/local.properties || true
            (cd android && ./gradlew assembleDebug --no-daemon) || echo "Gradle build failed, skipping APK size."
            APK_PATH=$(find android/app/build/outputs/apk -name "*.apk" | head -n 1 || true)
            if [ -n "$APK_PATH" ]; then
              echo "PR_APK_SIZE=$(du -h "$APK_PATH" | cut -f1)" >> $GITHUB_ENV
              echo "PR_APK_BYTES=$(du -sb "$APK_PATH" | cut -f1)" >> $GITHUB_ENV
            else
              echo "PR_APK_SIZE=N/A" >> $GITHUB_ENV
              echo "PR_APK_BYTES=0" >> $GITHUB_ENV
            fi
          else
            echo "No native android/ directory. Skipping APK size."
            echo "PR_APK_SIZE=N/A" >> $GITHUB_ENV
            echo "PR_APK_BYTES=0" >> $GITHUB_ENV
          fi

          # Top files report
          echo "## Largest JS bundles" > bundle-report.txt
          du -h bundle/index.android.bundle bundle/index.ios.bundle 2>/dev/null | sort -rh >> bundle-report.txt

      - name: Checkout base branch
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

      - name: Build and analyze base bundle
        if: github.event_name == 'pull_request'
        run: |
          pnpm install --frozen-lockfile
          mkdir -p bundle_base/android bundle_base/ios
          pnpx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output bundle_base/index.android.bundle \
            --assets-dest bundle_base/android || echo "Base android bundle failed"

          pnpx react-native bundle \
            --platform ios \
            --dev false \
            --entry-file index.js \
            --bundle-output bundle_base/index.ios.bundle \
            --assets-dest bundle_base/ios || echo "Base iOS bundle failed"

          echo "BASE_ANDROID_BYTES=$(wc -c < bundle_base/index.android.bundle || echo 0)" >> $GITHUB_ENV
          echo "BASE_IOS_BYTES=$(wc -c < bundle_base/index.ios.bundle || echo 0)" >> $GITHUB_ENV
          echo "BASE_ANDROID_ASSETS_BYTES=$(du -sb bundle_base/android | cut -f1 || echo 0)" >> $GITHUB_ENV
          echo "BASE_IOS_ASSETS_BYTES=$(du -sb bundle_base/ios | cut -f1 || echo 0)" >> $GITHUB_ENV

      - name: Compare bundle sizes
        if: github.event_name == 'pull_request'
        id: compare
        run: |
          ANDROID_DIFF=$(($PR_ANDROID_BYTES - ${BASE_ANDROID_BYTES:-0}))
          IOS_DIFF=$(($PR_IOS_BYTES - ${BASE_IOS_BYTES:-0}))
          ANDROID_PCT=$(awk "BEGIN { base=${BASE_ANDROID_BYTES:-0}; if (base==0) {printf \"0\"} else {printf \"%.2f\", ($PR_ANDROID_BYTES - base)/base*100} }")
          IOS_PCT=$(awk "BEGIN { base=${BASE_IOS_BYTES:-0}; if (base==0) {printf \"0\"} else {printf \"%.2f\", ($PR_IOS_BYTES - base)/base*100} }")

          echo "android_diff=$ANDROID_DIFF" >> $GITHUB_OUTPUT
          echo "ios_diff=$IOS_DIFF" >> $GITHUB_OUTPUT
          echo "android_pct=$ANDROID_PCT" >> $GITHUB_OUTPUT
          echo "ios_pct=$IOS_PCT" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prAndroidSize = process.env.PR_ANDROID_SIZE || 'N/A';
            const prIosSize = process.env.PR_IOS_SIZE || 'N/A';
            const prAndroidAssetsSize = process.env.PR_ANDROID_ASSETS_SIZE || 'N/A';
            const prIosAssetsSize = process.env.PR_IOS_ASSETS_SIZE || 'N/A';
            const prApkSize = process.env.PR_APK_SIZE || 'N/A';

            const androidDiff = parseInt('${{ steps.compare.outputs.android_diff }}' || '0');
            const iosDiff = parseInt('${{ steps.compare.outputs.ios_diff }}' || '0');
            const androidPct = parseFloat('${{ steps.compare.outputs.android_pct }}' || '0');
            const iosPct = parseFloat('${{ steps.compare.outputs.ios_pct }}' || '0');

            const androidStatus = androidDiff > 0 ? 'increased' : androidDiff < 0 ? 'decreased' : 'unchanged';
            const iosStatus = iosDiff > 0 ? 'increased' : iosDiff < 0 ? 'decreased' : 'unchanged';
            const androidEmoji = androidDiff > 0 ? (androidPct > 5 ? '‚ö†Ô∏è' : 'üìà') : androidDiff < 0 ? '‚úÖ' : 'üìä';
            const iosEmoji = iosDiff > 0 ? (iosPct > 5 ? '‚ö†Ô∏è' : 'üìà') : iosDiff < 0 ? '‚úÖ' : 'üìä';

            const comment = `## üìä React Native Bundle Size Report

            ### Android
            - **Bundle**: ${prAndroidSize}
            - **Assets**: ${prAndroidAssetsSize}
            - **Change**: ${androidDiff > 0 ? '+' : ''}${(androidDiff/1024).toFixed(2)} KB (${androidPct > 0 ? '+' : ''}${androidPct}%) ${androidEmoji} (${androidStatus})
            - **APK (debug)**: ${prApkSize}

            ### iOS
            - **Bundle**: ${prIosSize}
            - **Assets**: ${prIosAssetsSize}
            - **Change**: ${iosDiff > 0 ? '+' : ''}${(iosDiff/1024).toFixed(2)} KB (${iosPct > 0 ? '+' : ''}${iosPct}%) ${iosEmoji} (${iosStatus})

            ${androidPct > 10 || iosPct > 10 ? 'üö® **Critical**: One platform increased by more than 10% ‚Äî please review.' : (androidPct > 5 || iosPct > 5) ? '‚ö†Ô∏è **Warning**: Bundle size increased by more than 5%.' : '‚úÖ Bundle sizes look healthy.'}

            <details>
            <summary>üì¶ Bundle files</summary>

            \`\`\`
            ${require('fs').readFileSync('bundle-report.txt','utf8')}
            \`\`\`
            </details>

            ---
            *RN bundle analysis powered by GitHub Actions*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Bundle Size Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

            // Fail if either platform increased too much
            if (androidPct > 10 || iosPct > 10) {
              core.setFailed('Bundle size increased by more than 10% on at least one platform');
            }

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: rn-bundle-analysis
          path: |
            bundle/
            bundle_base/
            bundle-report.txt
